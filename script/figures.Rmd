---
title: "figures"
author: "Katie Florko"
date: "12/07/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script takes the plots made in Appendix 3 and formats, rearranges, and exports them as figures for the paper and supplemental material.

# Libraries
```{r}
library(ggplot2)
library(cowplot)
```



# Template
```{r}

p1 <- ggplot() + theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        text = element_text(size=12),
        strip.background = element_rect(colour = "white"),
        legend.position = c(0.86, 0.82), 
        legend.direction = "vertical", 
        legend.background = element_blank()) 
```


# Fig. 4
```{r}
fig4a <- p1 + 
  geom_tile(data = fish, aes(x = lon, y = lat, fill = preydiv)) +
  scale_fill_viridis(option = "mako", limits = c(0.5, 0.75), breaks = c(0.5, 0.62, 0.75)) +
  labs(fill = 'Prey\ndiversity') +
  geom_polygon(data = nat_trans, aes(x=long, y=lat, group=group), colour = "white", fill = "grey90", size = 0.3) +
  geom_point(data=seal, aes(x=lon, y=lat), size=1.75, alpha = 0.6, color = "#FCEEAE") + 
  geom_path(data=seal, aes(x=lon, y=lat), color = "#FCEEAE") +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.key.height=unit(0.3,"cm"),
        legend.key.width = unit(0.4, "cm"),
        legend.direction = "horizontal",
        legend.position = c(0.80, 0.89)) +
  ggtitle("A)") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5))

fig4b <- p1 + 
  geom_polygon(data = nat_trans, aes(x=long, y=lat, group=group), colour = "white", fill = "grey90", size = 0.3) +
  geom_point(data=data_rsf, aes(x=x_, y=y_, color = case_), alpha = 0.6) +
  geom_path(data=seal, aes(x=lon, y=lat), color = "#5B207C") +
  scale_color_manual(values = c("#F1A97A", "#5B207C"), 
                     label = c("Available", "Observed"), name = "Data type") +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.position = c(0.80, 0.89)) +
  ggtitle("B)") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5)) 

fig4c <- p1 + 
  geom_point(data=data_ssf, aes(x=x2_, y=y2_, color = case_), alpha = 0.6) +
  geom_path(data=seal, aes(x=lon, y=lat), color = "#5B207C") +
  scale_color_manual(values = c("#F1A97A", "#5B207C"), 
                     label = c("Available", "Observed"), name = "Data type") +
  geom_polygon(data = nat_trans, aes(x=long, y=lat, group=group), colour = "white", fill = "grey90", size = 0.3) +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.position = c(0.80, 0.89)) +
  ggtitle("C)") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5)) 


res_both <- dplyr::bind_rows(res1 %>% mutate(Model = "RSF"),
                      res2 %>% mutate(Model = "SSF"))

fig4d <- ggplot() + theme_minimal() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_line(data = res_both, aes(x = preydiv_x1, y = log_rss, color = Model), size = 1, linetype = 2) +
  geom_ribbon(data = res_both, aes(y = log_rss, ymin=lwr, ymax=upr, x=preydiv_x1, fill = Model), alpha = 0.4) +
  scale_color_manual(values = c("#BE496F", "#F8D59F")) +
  scale_fill_manual(values = c("#BE496F", "#F8D59F")) +
  xlab("Prey diversity") +
  ylab("\nlog-RSS") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  ggtitle("D)") +
  theme(legend.position = c(0.15, 0.88)) +
  xlim(0.55, 0.70) +
  ylim(-2.5, 2.5)

fig4e <- ggplot(results_ssf2, aes(x = preydiv_x1, y = (log_rss))) +
  theme_minimal() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray")  +
  geom_ribbon(aes(ymin=lwr, ymax=upr, x=preydiv_x1, fill = Speed, group = Speed), alpha = 0.5) +
  geom_line(size = 1, aes(color = Speed, group = Speed)) +
  scale_fill_viridis_d(option="rocket", breaks=c('slow', 'moderate', 'fast')) +
  scale_color_viridis_d(option="rocket", breaks=c('slow', 'moderate', 'fast')) +
  xlab("Prey diversity") +
  ylab("\nlog-RSS") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  ggtitle("E)") +
  theme(legend.position = c(0.2, 0.84)) +
  xlim(0.55, 0.70) +
  ylim(-2.5, 2.5)

fig4f <- line_hmm +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  ggtitle("F)") +
  theme(legend.position = c(0.28, 0.84)) +
  ylab("\nStationary state probabilities") 

tiff(file = "figures/asus_fig4.tiff", units="in", width=10, height=7.5, res=500)
plot_grid(fig4a, fig4b, fig4c, fig4d, fig4e, fig4f, ncol = 3)
dev.off()
```

# Fig. 5
```{r}
fig5a <- p1 +
  geom_tile(data = newfish, aes(x = x,y = y, fill = rsf_prediction)) +
  scale_fill_viridis(option = "mako", name = "Predicted\nprobability", limits = c(0, 0.3), breaks = c(0.0, 0.15, 0.3)) +
  geom_polygon(data = nat_trans, aes(x=long,y=lat,group=group), fill = "grey80", color = "white") +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.key.height=unit(0.3,"cm"),
        legend.key.width = unit(0.4, "cm"),
        legend.direction = "horizontal",
        legend.position = c(0.80, 0.89)) +
  ggtitle("A) RSF") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5))


fig5b <- p1 + 
  geom_tile(data = uds_ssf1, aes(x = x,y = y, fill = preydiv)) +
  scale_fill_viridis(option = "mako", name = "Predicted\nprobability", breaks = c(0,0.06,0.12)) +
  geom_polygon(data = nat_trans, aes(x=long,y=lat,group=group), fill = "grey80", color = "white") +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.key.height=unit(0.3,"cm"),
        legend.key.width = unit(0.4, "cm"),
        legend.direction = "horizontal",
        legend.position = c(0.80, 0.89)) +
  ggtitle("B) SSF") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5))

fig5c <- p1 +
  scale_fill_viridis(option = "mako", limits = c(0.5, 0.75), name = "Prey\ndiversity") +
  geom_path(data=data_hmm, aes(x=x, y=y, color = state, group =ID)) + 
  geom_point(data=data_hmm, aes(x=x, y=y, color = state, shape = state), size=2, alpha = 0.8) + 
  scale_color_manual(values = c("#99DDB6", "#539D9C", "#312C66"), 
                     labels = c("Localized search", "Area-restricted search", "Travelling"), 
                     name = "HMM state") +
  scale_shape_manual(values = c(15, 16, 17), 
                     labels=c("Localized search", "Area-restricted search", "Travelling"), 
                     name = "HMM state") +
  geom_polygon(data = nat_trans, aes(x=long,y=lat,group=group), fill = "grey80", color = "white") +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.key.height=unit(0.3,"cm"),
        legend.key.width = unit(0.4, "cm"),
        legend.direction = "vertical",
        legend.position = c(0.3, 0.1)) +
  ggtitle("C) HMM decoded states") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5))

fig5d <- p1 +
  geom_tile(data = newfish_long %>% filter(model == "hmm_state1"), 
            aes(x = x, y = y, fill = prediction)) +
  scale_fill_viridis(option = "mako", limits = c(0,1), breaks = c(0.0, 0.5, 1.0)) +
  labs(fill = 'Predicted\nprobability') +
  geom_polygon(data = nat_trans, aes(x=long,y=lat,group=group), colour = "white", fill = "grey90", size = 0.3) +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.key.height=unit(0.3,"cm"),
        legend.key.width = unit(0.4, "cm"),
        legend.direction = "horizontal",
        legend.position = c(0.80, 0.89)) +
  ggtitle("D) HMM state: Localized search") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5))

fig5e <- p1 +
  geom_tile(data = newfish_long %>% filter(model == "hmm_state2"), 
            aes(x = x, y = y, fill = prediction)) +
  scale_fill_viridis(option = "mako", limits = c(0,1), breaks = c(0.0, 0.5, 1.0)) +
  labs(fill = 'Predicted\nprobability') +
  geom_polygon(data = nat_trans, aes(x=long,y=lat,group=group), colour = "white", fill = "grey90", size = 0.3) +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.key.height=unit(0.3,"cm"),
        legend.key.width = unit(0.4, "cm"),
        legend.direction = "horizontal",
        legend.position = c(0.80, 0.89)) +
  ggtitle("E) HMM state: Area-restricted search") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5))

fig5f <- p1 +
  geom_tile(data = newfish_long %>% filter(model == "hmm_state3"), 
            aes(x = x, y = y, fill = prediction)) +
  scale_fill_viridis(option = "mako", limits = c(0,1), breaks = c(0.0, 0.5, 1.0)) +
  labs(fill = 'Predicted\nprobability') +
  geom_polygon(data = nat_trans, aes(x=long,y=lat,group=group), colour = "white", fill = "grey90", size = 0.3) +
  coord_cartesian(xlim = c(150000,550000), ylim = c(-500000,-50000), expand = F) +
  theme(legend.key.height=unit(0.3,"cm"),
        legend.key.width = unit(0.4, "cm"),
        legend.direction = "horizontal",
        legend.position = c(0.80, 0.89)) +
  ggtitle("F) HMM state: Travelling") +
  ylab(" \n \n  ") + xlab("") +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, size = 1) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, size = 1) +
  guides(fill = guide_colourbar(title.position="top", 
         title.hjust = 0.5), 
         size = guide_legend(title.position="top", title.hjust = 0.5))

tiff(file = "figures/asus_fig5.tiff", units="in", width=12, height = 8.5, res=500)
plot_grid(fig5a, fig5b, fig5c, fig5d, fig5e, fig5f, ncol = 3)
dev.off()
```

